---
title: "Obtaining reference data from Differentiation Map (GSE24759)"
author: 
- name: Jared M. Andrews
  affiliation: Washington University in St. Louis, School of Medicine, St. Louis, MO, USA
date: "Revised: September 4th, 2019"
output: 
  BiocStyle::html_document
---

```{r setup, echo=FALSE, include=FALSE}
library(BiocStyle)
knitr::opts_chunk$set(error=FALSE, message=FALSE, warning=FALSE)
```

# Overview

This RNA microarray dataset was downloaded from [GEO24759](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE24759).
Values were already RMA normalized. 
The only additional processing done was to collapse probes to gene level values by keeping probes with the highest average across all samples.
'Main' and 'fine' labels were manually assigned to each sample based on cell type as specified in the GEO repository.

# Data retrieval

First, we'll retrieve the normalized data from the GEO repository.

```{r retrieve_from_geo}
library(GEOquery)
gse24759 <- getGEO("GSE24759")
logcounts <- gse24759$GSE24759_series_matrix.txt.gz@assayData$exprs
logcounts <- as.data.frame(logcounts)
```

# Data processing
The counts matrix has probes rather than gene symbols, so we need to get the appropriate gene symbols.

```{r get_symbols}
genes <- gse24759$GSE24759_series_matrix.txt.gz@featureData@data$`Gene Symbol`
probes <- row.names(logcounts)
mapper <- as.data.frame(cbind(genes, probes))
logcounts$genes <- mapper$genes[match(rownames(logcounts), mapper$probes)]
logcounts <- logcounts[,c(ncol(logcounts),1:(ncol(logcounts)-1))]
```

Some probes don't have gene symbols, so we'll remove those rows.

```{r drop_empties}
logcounts <- logcounts[!(logcounts$genes == ""),]
logcounts <- logcounts[!(is.na(logcounts$genes)),]
```

Some genes have multiple probes, so we will collapse them to use the probe with the highest median signal across samples.

```{r collapse_dup_genes}
logcounts$med <- rowMedians(as.matrix(logcounts[, 2:ncol(logcounts)]))
logcounts <- logcounts[order(logcounts[, 'genes'], -logcounts[, 'med']),]
logcounts <- logcounts[!duplicated(logcounts$genes), ]
row.names(logcounts) <- logcounts$genes

logcounts$genes <- NULL
logcounts$med <- NULL
```

# Label the samples
We can now apply human-readable labels to each sample.
Our print logs from the `CombineSamples` function provide the number of samples in each file, allowing us to create label vectors of the correct size.

```{r create_metadata}
main <- c(
	"Basophils", "Basophils", "Basophils", "Basophils",
	"Basophils", "Basophils", "B cells", "B cells",
	"B cells", "B cells", "B cells", "B cells",
	"B cells", "B cells", "B cells", "B cells",
	"B cells", "B cells", "B cells", "B cells",
	"B cells", "B cells", "B cells", "B cells",
	"B cells", "B cells", "CMPs", "CMPs",
	"CMPs", "CMPs", "Dendritic cells", "Dendritic cells",
	"Dendritic cells", "Dendritic cells", "Dendritic cells", "Dendritic cells",
	"Dendritic cells", "Dendritic cells", "Dendritic cells", "Dendritic cells",
	"Eosinophils", "Eosinophils", "Eosinophils", "Eosinophils",
	"Eosinophils", "Erythroid cells", "Erythroid cells", "Erythroid cells",
	"Erythroid cells", "Erythroid cells", "Erythroid cells", "Erythroid cells",
	"Erythroid cells", "Erythroid cells", "Erythroid cells", "Erythroid cells",
	"Erythroid cells", "Erythroid cells", "Erythroid cells", "Erythroid cells",
	"Erythroid cells", "Erythroid cells", "Erythroid cells", "Erythroid cells",
	"Erythroid cells", "Erythroid cells", "Erythroid cells", "Erythroid cells",
	"Erythroid cells", "Erythroid cells", "Erythroid cells", "Erythroid cells",
	"Erythroid cells", "Erythroid cells", "Erythroid cells", "Erythroid cells",
	"Erythroid cells", "Erythroid cells", "GMPs", "GMPs",
	"GMPs", "GMPs", "Granulocytes", "Granulocytes",
	"Granulocytes", "Granulocytes", "Granulocytes", "Granulocytes",
	"Granulocytes", "Granulocytes", "Granulocytes", "Granulocytes",
	"Granulocytes", "Granulocytes", "Granulocytes", "HSCs",
	"HSCs", "HSCs", "HSCs", "HSCs",
	"HSCs", "HSCs", "HSCs", "HSCs",
	"HSCs", "HSCs", "HSCs", "HSCs",
	"HSCs", "Megakaryocytes", "Megakaryocytes", "Megakaryocytes",
	"Megakaryocytes", "Megakaryocytes", "Megakaryocytes", "Megakaryocytes",
	"Megakaryocytes", "Megakaryocytes", "Megakaryocytes", "Megakaryocytes",
	"Megakaryocytes", "MEPs", "MEPs", "MEPs",
	"MEPs", "MEPs", "MEPs", "MEPs",
	"MEPs", "MEPs", "Monocytes", "Monocytes",
	"Monocytes", "Monocytes", "Monocytes", "Monocytes",
	"Monocytes", "Monocytes", "Monocytes", "NK cells",
	"NK cells", "NK cells", "NK cells", "NK cells",
	"NK cells", "NK cells", "NK cells", "NK cells",
	"NK cells", "NK cells", "NK cells", "NK cells",
	"NK cells", "NK T cells", "NK T cells", "NK T cells",
	"NK T cells", "B cells", "B cells", "B cells",
	"B cells", "B cells", "B cells", "B cells",
	"B cells", "B cells", "CD8+ T cells", "CD8+ T cells",
	"CD8+ T cells", "CD8+ T cells", "CD8+ T cells", "CD8+ T cells",
	"CD8+ T cells", "CD8+ T cells", "CD8+ T cells", "CD8+ T cells",
	"CD8+ T cells", "CD8+ T cells", "CD8+ T cells", "CD8+ T cells",
	"CD8+ T cells", "CD8+ T cells", "CD8+ T cells", "CD8+ T cells",
	"CD8+ T cells", "CD8+ T cells", "CD8+ T cells", "CD8+ T cells",
	"CD8+ T cells", "CD8+ T cells", "CD4+ T cells", "CD4+ T cells",
	"CD4+ T cells", "CD4+ T cells", "CD4+ T cells", "CD4+ T cells",
	"CD4+ T cells", "CD4+ T cells", "CD4+ T cells", "CD4+ T cells",
	"CD4+ T cells", "CD4+ T cells", "CD4+ T cells", "CD4+ T cells",
	"CD4+ T cells", "CD4+ T cells", "CD4+ T cells", "CD4+ T cells",
	"CD4+ T cells", "CD4+ T cells", "CD4+ T cells"
)

# Then 'fine' labels.
fine <- c(
	"Basophils", "Basophils",  
	"Basophils", "Basophils",  
	"Basophils", "Basophils",  
	"Naïve B cells", "Naïve B cells",    
	"Naïve B cells", "Naïve B cells",    
	"Naïve B cells", "Mature B-cells class able to switch",
	"Mature B-cells class able to switch", "Mature B-cells class able to switch",
	"Mature B-cells class able to switch", "Mature B-cells class able to switch",
	"Mature B-cells", "Mature B-cells",   
	"Mature B-cells", "Mature B-cells",   
	"Mature B-cells", "Mature B-cells class switched",
	"Mature B-cells class switched", "Mature B-cells class switched",
	"Mature B-cells class switched", "Mature B-cells class switched",
	"Common myeloid progenitors", "Common myeloid progenitors",   
	"Common myeloid progenitors", "Common myeloid progenitors",   
	"Plasmacytoid Dendritic Cells", "Plasmacytoid Dendritic Cells", 
	"Plasmacytoid Dendritic Cells", "Plasmacytoid Dendritic Cells", 
	"Plasmacytoid Dendritic Cells", "Myeloid Dendritic Cells",
	"Myeloid Dendritic Cells", "Myeloid Dendritic Cells",
	"Myeloid Dendritic Cells", "Myeloid Dendritic Cells",
	"Eosinophils", "Eosinophils",
	"Eosinophils", "Eosinophils",
	"Eosinophils", "Erythroid_CD34+ CD71+ GlyA-",  
	"Erythroid_CD34+ CD71+ GlyA-", "Erythroid_CD34+ CD71+ GlyA-",  
	"Erythroid_CD34+ CD71+ GlyA-", "Erythroid_CD34+ CD71+ GlyA-",  
	"Erythroid_CD34+ CD71+ GlyA-", "Erythroid_CD34+ CD71+ GlyA-",  
	"Erythroid_CD34- CD71+ GlyA-", "Erythroid_CD34- CD71+ GlyA-",  
	"Erythroid_CD34- CD71+ GlyA-", "Erythroid_CD34- CD71+ GlyA-",  
	"Erythroid_CD34- CD71+ GlyA-", "Erythroid_CD34- CD71+ GlyA-",  
	"Erythroid_CD34- CD71+ GlyA-", "Erythroid_CD34- CD71+ GlyA+",  
	"Erythroid_CD34- CD71+ GlyA+", "Erythroid_CD34- CD71+ GlyA+",  
	"Erythroid_CD34- CD71+ GlyA+", "Erythroid_CD34- CD71+ GlyA+",  
	"Erythroid_CD34- CD71+ GlyA+", "Erythroid_CD34- CD71lo GlyA+", 
	"Erythroid_CD34- CD71lo GlyA+", "Erythroid_CD34- CD71lo GlyA+", 
	"Erythroid_CD34- CD71lo GlyA+", "Erythroid_CD34- CD71lo GlyA+", 
	"Erythroid_CD34- CD71lo GlyA+", "Erythroid_CD34- CD71lo GlyA+", 
	"Erythroid_CD34- CD71- GlyA+", "Erythroid_CD34- CD71- GlyA+",  
	"Erythroid_CD34- CD71- GlyA+", "Erythroid_CD34- CD71- GlyA+",  
	"Erythroid_CD34- CD71- GlyA+", "Erythroid_CD34- CD71- GlyA+",  
	"Granulocyte/monocyte progenitors", "Granulocyte/monocyte progenitors",   
	"Granulocyte/monocyte progenitors", "Granulocyte/monocyte progenitors",   
	"Colony Forming Unit-Granulocytes", "Colony Forming Unit-Granulocytes",   
	"Colony Forming Unit-Granulocytes", "Colony Forming Unit-Granulocytes",   
	"Colony Forming Unit-Granulocytes", "Granulocyte (Neutrophilic Metamyelocytes)",
	"Granulocyte (Neutrophilic Metamyelocytes)", "Granulocyte (Neutrophilic Metamyelocytes)",
	"Granulocyte (Neutrophilic Metamyelocytes)", "Granulocyte (Neutrophils)",    
	"Granulocyte (Neutrophils)", "Granulocyte (Neutrophils)",    
	"Granulocyte (Neutrophils)", "Hematopoietic stem cells_CD133+ CD34dim",  
	"Hematopoietic stem cells_CD133+ CD34dim", "Hematopoietic stem cells_CD133+ CD34dim",  
	"Hematopoietic stem cells_CD133+ CD34dim", "Hematopoietic stem cells_CD133+ CD34dim",  
	"Hematopoietic stem cells_CD133+ CD34dim", "Hematopoietic stem cells_CD133+ CD34dim",  
	"Hematopoietic stem cells_CD133+ CD34dim", "Hematopoietic stem cells_CD133+ CD34dim",  
	"Hematopoietic stem cells_CD133+ CD34dim", "Hematopoietic stem cell_CD38- CD34+",
	"Hematopoietic stem cell_CD38- CD34+", "Hematopoietic stem cell_CD38- CD34+",
	"Hematopoietic stem cell_CD38- CD34+", "Colony Forming Unit-Megakaryocytic", 
	"Colony Forming Unit-Megakaryocytic", "Colony Forming Unit-Megakaryocytic", 
	"Colony Forming Unit-Megakaryocytic", "Colony Forming Unit-Megakaryocytic", 
	"Megakaryocytes", "Megakaryocytes",   
	"Megakaryocytes", "Megakaryocytes",   
	"Megakaryocytes", "Megakaryocytes",   
	"Megakaryocytes", "Megakaryocyte/erythroid progenitors",
	"Megakaryocyte/erythroid progenitors", "Megakaryocyte/erythroid progenitors",
	"Megakaryocyte/erythroid progenitors", "Megakaryocyte/erythroid progenitors",
	"Megakaryocyte/erythroid progenitors", "Megakaryocyte/erythroid progenitors",
	"Megakaryocyte/erythroid progenitors", "Megakaryocyte/erythroid progenitors",
	"Colony Forming Unit-Monocytes", "Colony Forming Unit-Monocytes",
	"Colony Forming Unit-Monocytes", "Colony Forming Unit-Monocytes",
	"Monocytes", "Monocytes",  
	"Monocytes", "Monocytes",  
	"Monocytes", "Mature NK cells_CD56- CD16+ CD3-",   
	"Mature NK cells_CD56- CD16+ CD3-", "Mature NK cells_CD56- CD16+ CD3-",   
	"Mature NK cells_CD56- CD16+ CD3-", "Mature NK cells_CD56+ CD16+ CD3-",   
	"Mature NK cells_CD56+ CD16+ CD3-", "Mature NK cells_CD56+ CD16+ CD3-",   
	"Mature NK cells_CD56+ CD16+ CD3-", "Mature NK cells_CD56+ CD16+ CD3-",   
	"Mature NK cells_CD56- CD16- CD3-", "Mature NK cells_CD56- CD16- CD3-",   
	"Mature NK cells_CD56- CD16- CD3-", "Mature NK cells_CD56- CD16- CD3-",   
	"Mature NK cells_CD56- CD16- CD3-", "NK T cells", 
	"NK T cells", "NK T cells", 
	"NK T cells", "Early B-cells",    
	"Early B-cells", "Early B-cells",    
	"Early B-cells", "Pro B-cells",
	"Pro B-cells", "Pro B-cells",
	"Pro B-cells", "Pro B-cells",
	"CD8+ Effector Memory RA", "CD8+ Effector Memory RA",
	"CD8+ Effector Memory RA", "CD8+ Effector Memory RA",
	"Naive CD8+ T-cells", "Naive CD8+ T-cells",     
	"Naive CD8+ T-cells", "Naive CD8+ T-cells",     
	"Naive CD8+ T-cells", "Naive CD8+ T-cells",     
	"Naive CD8+ T-cells", "CD8+ Effector Memory",   
	"CD8+ Effector Memory", "CD8+ Effector Memory",   
	"CD8+ Effector Memory", "CD8+ Effector Memory",   
	"CD8+ Effector Memory", "CD8+ Central Memory",   
	"CD8+ Central Memory", "CD8+ Central Memory",    
	"CD8+ Central Memory", "CD8+ Central Memory",    
	"CD8+ Central Memory", "CD8+ Central Memory",    
	"Naive CD4+ T-cells", "Naive CD4+ T-cells",     
	"Naive CD4+ T-cells", "Naive CD4+ T-cells",     
	"Naive CD4+ T-cells", "Naive CD4+ T-cells",     
	"Naive CD4+ T-cells", "CD4+ Effector Memory",  
	"CD4+ Effector Memory", "CD4+ Effector Memory",   
	"CD4+ Effector Memory", "CD4+ Effector Memory",   
	"CD4+ Effector Memory", "CD4+ Effector Memory",   
	"CD4+ Central Memory", "CD4+ Central Memory",    
	"CD4+ Central Memory", "CD4+ Central Memory",    
	"CD4+ Central Memory", "CD4+ Central Memory",    
	"CD4+ Central Memory"
)

logcounts <- as.matrix(logcounts)

library(S4Vectors)
coldata <- DataFrame(row.names = colnames(logcounts),
                     label.main = main,
                     label.fine = fine)
```


# Saving to file

Now the counts and metadata can be saved for upload to `r Biocpkg("ExperimentHub")`.

```{r save_for_ExpHub}
path <- file.path("SingleR", "dmap", "1.0.0")
dir.create(path, showWarnings = FALSE, recursive = TRUE)

saveRDS(logcounts, file = file.path(path, "logcounts.rds"))
saveRDS(coldata, file = file.path(path, "coldata.rds"))
```

# Session info

```{r}
sessionInfo()
```
